<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Journey - 虚拟旅行游戏</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { User, MapPin, BookOpen, Settings, Send } = lucide;

        // =============== CONSTANTS ===============
        const POPULAR_LOCATIONS = [
            '北京', '上海', '成都', '西安', '杭州', '南京', 
            '东京', '首尔', '曼谷', '新加坡', '巴黎', '伦敦',
            '纽约', '洛杉矶', '悉尼', '罗马'
        ];

        const TRAVEL_METHODS = [
            { id: 'driving', name: '自驾游', desc: '开车自由行，灵活安排路线' },
            { id: 'walking', name: '徒步旅行', desc: '步行探索，深度体验当地' },
            { id: 'public', name: '公共交通', desc: '火车、巴士等公共交通' },
            { id: 'backpacking', name: '背包客', desc: '经济实惠的背包旅行' },
            { id: 'luxury', name: '豪华旅行', desc: '舒适享受的高端旅行' }
        ];

        const TRAVEL_STYLES = [
            { id: 'adventure', name: '探险型', desc: '寻找刺激和新奇体验' },
            { id: 'leisure', name: '休闲型', desc: '放松身心，慢节奏游览' },
            { id: 'cultural', name: '文化体验型', desc: '深入了解当地文化历史' },
            { id: 'foodie', name: '美食寻访型', desc: '品尝各地特色美食' }
        ];

        const NAVIGATION_ITEMS = [
            { id: 'setup', name: '角色设定', icon: User },
            { id: 'traveling', name: '旅行中', icon: MapPin },
            { id: 'diary', name: '旅行日记', icon: BookOpen },
            { id: 'settings', name: '设置', icon: Settings }
        ];

        // =============== API SERVICE ===============
        class APIService {
            constructor() {
                this.provider = 'CLAUDE';
                this.apiKey = '';
            }

            async callLLM(prompt, expectJSON = false) {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API调用失败: ${response.status}`);
                    }

                    const data = await response.json();
                    let responseText = data.content[0].text;

                    if (expectJSON) {
                        responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                        return JSON.parse(responseText);
                    }

                    return responseText;
                } catch (error) {
                    console.error("API调用错误:", error);
                    throw error;
                }
            }
        }

        const apiService = new APIService();

        // =============== STORAGE SERVICE ===============
        class StorageService {
            constructor() {
                this.STORAGE_KEY = 'avatar-journey-save';
                this.CURRENT_VERSION = '1.0.0';
            }

            save(data) {
                try {
                    const saveData = {
                        version: this.CURRENT_VERSION,
                        timestamp: Date.now(),
                        data: data
                    };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(saveData));
                    return true;
                } catch (error) {
                    console.error('保存数据失败:', error);
                    return false;
                }
            }

            load() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (!saved) return null;
                    
                    const saveData = JSON.parse(saved);
                    return this.migrateSaveData(saveData);
                } catch (error) {
                    console.error('加载数据失败:', error);
                    return null;
                }
            }

            exportSave(data) {
                try {
                    const saveData = {
                        version: this.CURRENT_VERSION,
                        exportTime: new Date().toISOString(),
                        gameTitle: 'Avatar Journey',
                        data: data
                    };
                    
                    const blob = new Blob([JSON.stringify(saveData, null, 2)], 
                        { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = `avatar-journey-${data.character.name || 'save'}-${Date.now()}.json`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    return true;
                } catch (error) {
                    console.error('导出存档失败:', error);
                    return false;
                }
            }

            importSave(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const saveData = JSON.parse(e.target.result);
                            
                            if (!saveData.version || !saveData.data) {
                                throw new Error('存档文件格式不正确');
                            }
                            
                            const migratedData = this.migrateSaveData(saveData);
                            resolve(migratedData);
                        } catch (error) {
                            reject(new Error(`导入存档失败: ${error.message}`));
                        }
                    };
                    reader.onerror = () => {
                        reject(new Error('文件读取失败'));
                    };
                    reader.readAsText(file);
                });
            }

            migrateSaveData(saveData) {
                try {
                    switch(saveData.version) {
                        case '1.0.0':
                            return saveData.data;
                        
                        case '0.9.0':
                            return this.upgradeTo1_0_0(saveData.data);
                        
                        default:
                            console.warn(`未知的存档版本: ${saveData.version}，尝试直接加载`);
                            return saveData.data;
                    }
                } catch (error) {
                    throw new Error(`存档版本 ${saveData.version} 不兼容: ${error.message}`);
                }
            }

            upgradeTo1_0_0(oldData) {
                return {
                    ...oldData,
                    version: '1.0.0'
                };
            }

            clear() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                    return true;
                } catch (error) {
                    console.error('清除存档失败:', error);
                    return false;
                }
            }

            hasSave() {
                return localStorage.getItem(this.STORAGE_KEY) !== null;
            }

            getSaveInfo() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (!saved) return null;
                    
                    const saveData = JSON.parse(saved);
                    return {
                        version: saveData.version,
                        timestamp: saveData.timestamp,
                        saveTime: new Date(saveData.timestamp).toLocaleString(),
                        hasCharacter: !!(saveData.data && saveData.data.character && saveData.data.character.name),
                        characterName: saveData.data?.character?.name || '',
                        isActive: saveData.data?.travelState?.isActive || false
                    };
                } catch (error) {
                    console.error('获取存档信息失败:', error);
                    return null;
                }
            }
        }

        const storageService = new StorageService();

        // =============== TRAVEL ENGINE ===============
        class TravelEngine {
            constructor() {
                this.scheduledTimeouts = new Map();
            }

            async startJourney(character, updateState) {
                if (!character.name || !character.departureLocation || !character.destination) {
                    throw new Error('请填写完整的角色信息和旅行配置');
                }

                const travelMethod = TRAVEL_METHODS.find(m => m.id === character.travelMethod);
                const travelStyle = TRAVEL_STYLES.find(s => s.id === character.travelStyle);
                
                const prompt = `
你是一个虚拟旅行游戏的AI助手，负责为用户的虚拟角色生成真实的旅行体验。

角色设定：
- 姓名：${character.name}
- 性格描述：${character.description}
- 出发地：${character.departureLocation}
- 目的地：${character.destination}
- 旅行方式：${travelMethod?.name}
- 旅行风格：${travelStyle?.name}

现在是${new Date().toLocaleString()}，角色刚开始这次旅行。请生成第一个旅行事件，并估算下次更新的时间。

请以JSON格式回复，包含以下字段：
{
  "currentLocation": "当前位置（详细地点）",
  "currentActivity": "当前正在做的事情",
  "eventDescription": "这次事件的详细描述（200字左右）",
  "nextEventTime": "下次事件预计发生的时间（小时后，如1.5表示1.5小时后）",
  "needsUserInput": false
}

要求：
1. 生成合理真实的旅行体验
2. 考虑旅行方式和从出发地到目的地的实际情况
3. 事件要有趣且符合角色设定
4. 时间估算要合理（通常0.5-3小时之间）
`;

                const result = await apiService.callLLM(prompt, true);
                
                const newEvent = {
                    id: Date.now(),
                    timestamp: new Date(),
                    type: 'journey_start',
                    content: result.eventDescription,
                    needsUserInput: result.needsUserInput || false
                };

                updateState(prevState => ({
                    ...prevState,
                    events: [...prevState.events, newEvent],
                    travelState: {
                        isActive: true,
                        currentLocation: result.currentLocation,
                        currentActivity: result.currentActivity,
                        lastUpdate: new Date(),
                        nextEventTime: new Date(Date.now() + result.nextEventTime * 60 * 60 * 1000)
                    }
                }));
                
                this.scheduleNextEvent(result.nextEventTime, character, updateState);
                
                return result;
            }

            scheduleNextEvent(hoursLater, character, updateState) {
                const delay = hoursLater * 60 * 60 * 1000;
                const timeoutId = setTimeout(() => {
                    this.generateNextEvent(character, updateState);
                }, delay);
                
                this.scheduledTimeouts.set('nextEvent', timeoutId);
            }

            async generateNextEvent(character, updateState) {
                console.log('生成下一个事件...');
            }

            async handleUserIntervention(userMessage, character, currentState, updateState) {
                const prompt = `
${character.name}正在旅行中。

当前状态：
- 位置：${currentState.travelState.currentLocation}
- 活动：${currentState.travelState.currentActivity}

用户发来消息想要干预角色的行动："${userMessage}"

请根据用户的建议，生成角色接下来的行动和遇到的情况。

请以JSON格式回复：
{
  "currentLocation": "位置（可能有变化）",
  "currentActivity": "根据用户建议调整的新活动",
  "eventDescription": "根据用户建议发生的新情况（200字左右）",
  "nextEventTime": "下次自动事件的时间（小时后）",
  "needsUserInput": false
}
`;

                const result = await apiService.callLLM(prompt, true);
                
                const newEvent = {
                    id: Date.now(),
                    timestamp: new Date(),
                    type: 'user_intervention',
                    content: result.eventDescription,
                    needsUserInput: false,
                    userMessage: userMessage
                };

                updateState(prevState => ({
                    ...prevState,
                    events: [...prevState.events, newEvent],
                    travelState: {
                        ...prevState.travelState,
                        currentLocation: result.currentLocation,
                        currentActivity: result.currentActivity,
                        lastUpdate: new Date(),
                        nextEventTime: new Date(Date.now() + result.nextEventTime * 60 * 60 * 1000)
                    },
                    userMessage: ''
                }));

                this.scheduleNextEvent(result.nextEventTime, character, updateState);
                return result;
            }

            clearAllTimeouts() {
                for (const [key, timeoutId] of this.scheduledTimeouts) {
                    clearTimeout(timeoutId);
                }
                this.scheduledTimeouts.clear();
            }
        }

        const travelEngine = new TravelEngine();

        // =============== COMPONENTS ===============
        const Navigation = ({ currentPage, setCurrentPage }) => (
            React.createElement('nav', { className: 'bg-white shadow-sm' },
                React.createElement('div', { className: 'max-w-6xl mx-auto px-4' },
                    React.createElement('div', { className: 'flex space-x-8' },
                        NAVIGATION_ITEMS.map(item => {
                            const Icon = item.icon;
                            return React.createElement('button', {
                                key: item.id,
                                onClick: () => setCurrentPage(item.id),
                                className: `flex items-center space-x-2 py-4 px-2 border-b-2 font-medium text-sm ${
                                    currentPage === item.id
                                        ? 'border-blue-500 text-blue-600'
                                        : 'border-transparent text-gray-500 hover:text-gray-700'
                                }`
                            },
                                React.createElement(Icon, { className: 'w-4 h-4' }),
                                React.createElement('span', null, item.name)
                            );
                        })
                    )
                )
            )
        );

        const EventCard = ({ event }) => (
            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
                React.createElement('div', { className: 'flex justify-between items-start mb-2' },
                    React.createElement('span', { className: 'text-sm text-gray-500' },
                        new Date(event.timestamp).toLocaleString()
                    ),
                    event.needsUserInput && React.createElement('span', { 
                        className: 'text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded' 
                    }, '等待选择')
                ),
                event.userMessage && React.createElement('div', { className: 'text-sm text-blue-600 mb-2' },
                    `💬 你的指示: ${event.userMessage}`
                ),
                React.createElement('p', { className: 'text-gray-700' }, event.content)
            )
        );

        const MessageInput = ({ onSendMessage, isWaitingResponse, characterName }) => {
            const [message, setMessage] = useState('');

            const handleSend = () => {
                if (!message.trim() || isWaitingResponse) return;
                onSendMessage(message);
                setMessage('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };

            return React.createElement('div', { className: 'space-y-3' },
                React.createElement('h3', { className: 'font-semibold' }, `与 ${characterName} 对话`),
                React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('input', {
                        type: 'text',
                        value: message,
                        onChange: (e) => setMessage(e.target.value),
                        onKeyPress: handleKeyPress,
                        className: 'flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                        placeholder: '给角色发送建议或指示...',
                        disabled: isWaitingResponse
                    }),
                    React.createElement('button', {
                        onClick: handleSend,
                        disabled: isWaitingResponse || !message.trim(),
                        className: 'bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50'
                    },
                        React.createElement(Send, { className: 'w-4 h-4' })
                    )
                ),
                React.createElement('p', { className: 'text-xs text-gray-500' },
                    '你可以建议角色的下一步行动，比如"去当地市场看看"或"和那个人继续聊天"'
                )
            );
        };

        // =============== MAIN COMPONENT ===============
        const AvatarJourney = () => {
            const [currentPage, setCurrentPage] = useState('setup');
            const [state, setState] = useState({
                character: {
                    name: '',
                    description: '',
                    departureLocation: '',
                    destination: '',
                    travelMethod: '',
                    travelStyle: ''
                },
                travelState: {
                    isActive: false,
                    currentLocation: '',
                    currentActivity: '',
                    lastUpdate: null,
                    nextEventTime: null
                },
                events: [],
                diaries: [],
                userMessage: '',
                isWaitingResponse: false
            });

            const autoSave = (newState) => {
                setState(newState);
                setTimeout(() => {
                    storageService.save(newState);
                }, 1000);
            };

            useEffect(() => {
                const savedData = storageService.load();
                if (savedData) {
                    setState(savedData);
                    if (savedData.travelState.isActive) {
                        setCurrentPage('traveling');
                    }
                }
            }, []);

            const handleImportSave = async (file) => {
                try {
                    const importedData = await storageService.importSave(file);
                    setState(importedData);
                    storageService.save(importedData);
                    alert('存档导入成功！');
                    
                    if (importedData.travelState.isActive) {
                        setCurrentPage('traveling');
                    } else {
                        setCurrentPage('setup');
                    }
                } catch (error) {
                    alert(error.message);
                }
            };

            const handleExportSave = () => {
                const success = storageService.exportSave(state);
                if (success) {
                    alert('存档导出成功！');
                } else {
                    alert('存档导出失败，请重试');
                }
            };

            // 页面组件
            const CharacterSetup = () => {
                const handleCharacterChange = (field, value) => {
                    const newState = {
                        ...state,
                        character: { ...state.character, [field]: value }
                    };
                    autoSave(newState);
                };

                const handleStartJourney = async () => {
                    const newState = { ...state, isWaitingResponse: true };
                    setState(newState);
                    try {
                        await travelEngine.startJourney(state.character, autoSave);
                        setCurrentPage('traveling');
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        const finalState = { ...state, isWaitingResponse: false };
                        autoSave(finalState);
                    }
                };

                const saveInfo = storageService.getSaveInfo();

                return React.createElement('div', { className: 'max-w-2xl mx-auto p-6 space-y-6' },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('h1', { className: 'text-3xl font-bold text-blue-600 mb-2' }, 'Avatar Journey'),
                        React.createElement('p', { className: 'text-gray-600' }, '创建你的虚拟化身，开始一段奇妙的旅程')
                    ),
                    
                    saveInfo && React.createElement('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
                        React.createElement('h3', { className: 'text-sm font-medium text-green-800 mb-2' }, '📁 发现存档'),
                        React.createElement('div', { className: 'text-sm text-green-700 space-y-1' },
                            React.createElement('p', null, `角色: ${saveInfo.characterName || '未命名'}`),
                            React.createElement('p', null, `保存时间: ${saveInfo.saveTime}`),
                            React.createElement('p', null, `状态: ${saveInfo.isActive ? '🌍 旅行中' : '📝 角色设定'}`)
                        ),
                        saveInfo.isActive && React.createElement('button', {
                            onClick: () => setCurrentPage('traveling'),
                            className: 'mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700'
                        }, '继续旅程')
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
                            React.createElement(User, { className: 'w-5 h-5' }),
                            '角色设定'
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '角色姓名'),
                            React.createElement('input', {
                                type: 'text',
                                value: state.character.name,
                                onChange: (e) => handleCharacterChange('name', e.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                placeholder: '给你的虚拟角色起个名字'
                            })
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '角色描述'),
                            React.createElement('textarea', {
                                value: state.character.description,
                                onChange: (e) => handleCharacterChange('description', e.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                rows: 3,
                                placeholder: '描述角色的性格、兴趣爱好、背景等'
                            })
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
                            React.createElement(MapPin, { className: 'w-5 h-5' }),
                            '旅行配置'
                        ),
                        
                        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '出发地'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: state.character.departureLocation,
                                    onChange: (e) => handleCharacterChange('departureLocation', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                    placeholder: '选择出发城市',
                                    list: 'locations'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, '目的地'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: state.character.destination,
                                    onChange: (e) => handleCharacterChange('destination', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                    placeholder: '选择目的地城市',
                                    list: 'locations'
                                })
                            )
                        ),

                        React.createElement('datalist', { id: 'locations' },
                            POPULAR_LOCATIONS.map(location => 
                                React.createElement('option', { key: location, value: location })
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '旅行方式'),
                            React.createElement('div', { className: 'grid grid-cols-1 gap-2' },
                                TRAVEL_METHODS.map(method => 
                                    React.createElement('label', { 
                                        key: method.id, 
                                        className: 'flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50' 
                                    },
                                        React.createElement('input', {
                                            type: 'radio',
                                            name: 'travelMethod',
                                            value: method.id,
                                            checked: state.character.travelMethod === method.id,
                                            onChange: (e) => handleCharacterChange('travelMethod', e.target.value),
                                            className: 'w-4 h-4 text-blue-600'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-medium' }, method.name),
                                            React.createElement('div', { className: 'text-sm text-gray-500' }, method.desc)
                                        )
                            )
                        ),

                        React.createElement('button', {
                            onClick: handleStartJourney,
                            disabled: state.isWaitingResponse || !state.character.name || !state.character.departureLocation || !state.character.destination,
                            className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50'
                        }, state.isWaitingResponse ? '正在准备旅程...' : '开始旅程')
                    )
                );
            };

            const TravelingView = () => {
                const handleSendMessage = async (message) => {
                    if (!message.trim() || state.isWaitingResponse) return;
                    
                    const newState = { ...state, isWaitingResponse: true };
                    setState(newState);
                    try {
                        await travelEngine.handleUserIntervention(message, state.character, state, autoSave);
                    } catch (error) {
                        alert('发送消息时出错，请重试');
                        console.error(error);
                    } finally {
                        const finalState = { ...state, isWaitingResponse: false };
                        autoSave(finalState);
                    }
                };

                if (!state.travelState.isActive) {
                    return React.createElement('div', { className: 'max-w-4xl mx-auto p-6' },
                        React.createElement('div', { className: 'text-center text-gray-500 py-12' },
                            React.createElement(User, { className: 'w-12 h-12 mx-auto mb-4 text-gray-300' }),
                            React.createElement('p', null, '还没有开始旅行'),
                            React.createElement('p', { className: 'text-sm' }, '请先设置角色信息并开始旅程')
                        )
                    );
                }

                return React.createElement('div', { className: 'max-w-4xl mx-auto p-6 space-y-6' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg' },
                        React.createElement('h2', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
                            React.createElement(User, { className: 'w-5 h-5' }),
                            `${state.character.name} 的旅程`
                        ),
                        
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-4' },
                            React.createElement('div', { className: 'bg-blue-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-blue-800' }, '当前位置'),
                                React.createElement('p', { className: 'text-blue-600' }, state.travelState.currentLocation)
                            ),
                            React.createElement('div', { className: 'bg-green-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-green-800' }, '正在进行'),
                                React.createElement('p', { className: 'text-green-600' }, state.travelState.currentActivity)
                            ),
                            React.createElement('div', { className: 'bg-orange-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-orange-800' }, '最后更新'),
                                React.createElement('p', { className: 'text-orange-600' },
                                    state.travelState.lastUpdate ? new Date(state.travelState.lastUpdate).toLocaleString() : ''
                                )
                            )
                        ),

                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('h3', { className: 'font-semibold' }, '旅行记录'),
                            React.createElement('div', { className: 'space-y-3 max-h-96 overflow-y-auto' },
                                state.events.length === 0 ? 
                                    React.createElement('div', { className: 'text-center text-gray-500 py-8' },
                                        React.createElement('p', null, '旅行记录将在这里显示')
                                    ) :
                                    state.events.map(event => 
                                        React.createElement(EventCard, { key: event.id, event: event })
                                    )
                            )
                        ),

                        React.createElement('div', { className: 'mt-6' },
                            React.createElement(MessageInput, {
                                onSendMessage: handleSendMessage,
                                isWaitingResponse: state.isWaitingResponse,
                                characterName: state.character.name
                            })
                        )
                    )
                );
            };

            const DiaryView = () => (
                React.createElement('div', { className: 'max-w-3xl mx-auto p-6 space-y-6' },
                    React.createElement('h2', { className: 'text-2xl font-semibold flex items-center gap-2' },
                        React.createElement(BookOpen, { className: 'w-6 h-6' }),
                        state.character.name ? `${state.character.name} 的旅行日记` : '旅行日记'
                    ),
                    
                    state.diaries.length === 0 ? 
                        React.createElement('div', { className: 'text-center text-gray-500 py-12' },
                            React.createElement(BookOpen, { className: 'w-12 h-12 mx-auto mb-4 text-gray-300' }),
                            React.createElement('p', null, '还没有日记记录'),
                            React.createElement('p', { className: 'text-sm' }, '开始旅行后会自动生成每日日记')
                        ) :
                        React.createElement('div', { className: 'space-y-6' },
                            state.diaries.map(diary => 
                                React.createElement('div', { key: diary.id, className: 'bg-white rounded-lg p-6 shadow-lg' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-2' }, diary.date),
                                    React.createElement('h4', { className: 'text-md font-medium text-blue-600 mb-3' }, diary.title),
                                    React.createElement('p', { className: 'text-gray-700 leading-relaxed mb-4' }, diary.content),
                                    diary.keyEvents && diary.keyEvents.length > 0 && 
                                        React.createElement('div', null,
                                            React.createElement('h5', { className: 'text-sm font-medium text-gray-600 mb-2' }, '关键事件：'),
                                            React.createElement('ul', { className: 'text-sm text-gray-500 space-y-1' },
                                                diary.keyEvents.map((event, index) => 
                                                    React.createElement('li', { key: index }, `• ${event}`)
                                                )
                                            )
                                        )
                                )
                            )
                        )
                )
            );

            const SettingsView = () => {
                const handleResetAllData = () => {
                    if (confirm('确定要重置所有数据吗？这将清除所有旅行记录和角色信息。')) {
                        travelEngine.clearAllTimeouts();
                        storageService.clear();
                        const newState = {
                            character: {
                                name: '',
                                description: '',
                                departureLocation: '',
                                destination: '',
                                travelMethod: '',
                                travelStyle: ''
                            },
                            travelState: {
                                isActive: false,
                                currentLocation: '',
                                currentActivity: '',
                                lastUpdate: null,
                                nextEventTime: null
                            },
                            events: [],
                            diaries: [],
                            userMessage: '',
                            isWaitingResponse: false
                        };
                        setState(newState);
                        setCurrentPage('setup');
                        alert('所有数据已重置');
                    }
                };

                const handleFileImport = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        handleImportSave(file);
                        event.target.value = '';
                    }
                };

                const saveInfo = storageService.getSaveInfo();

                return React.createElement('div', { className: 'max-w-2xl mx-auto p-6 space-y-6' },
                    React.createElement('h2', { className: 'text-2xl font-semibold flex items-center gap-2' },
                        React.createElement(Settings, { className: 'w-6 h-6' }),
                        '设置'
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h3', { className: 'text-lg font-semibold' }, '存档管理'),
                        
                        saveInfo && React.createElement('div', { className: 'bg-blue-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-blue-800 mb-2' }, '📁 当前存档'),
                            React.createElement('div', { className: 'text-sm text-blue-700 space-y-1' },
                                React.createElement('p', null, `角色: ${saveInfo.characterName || '未命名'}`),
                                React.createElement('p', null, `保存时间: ${saveInfo.saveTime}`),
                                React.createElement('p', null, `状态: ${saveInfo.isActive ? '🌍 旅行中' : '📝 角色设定'}`),
                                React.createElement('p', null, `版本: ${saveInfo.version}`)
                            )
                        ),

                        React.createElement('div', { className: 'space-y-3' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '导入存档'),
                                React.createElement('input', {
                                    type: 'file',
                                    accept: '.json',
                                    onChange: handleFileImport,
                                    className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
                                }),
                                React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, '选择 .json 格式的存档文件')
                            ),

                            React.createElement('button', {
                                onClick: handleExportSave,
                                disabled: !saveInfo,
                                className: 'w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed'
                            }, '导出当前存档')
                        ),

                        React.createElement('div', { className: 'bg-yellow-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-yellow-800 mb-2' }, '💡 存档说明'),
                            React.createElement('ul', { className: 'text-xs text-yellow-700 space-y-1' },
                                React.createElement('li', null, '• 游戏数据会自动保存到浏览器本地存储'),
                                React.createElement('li', null, '• 导出存档可以备份到本地文件'),
                                React.createElement('li', null, '• 导入存档可以恢复之前的游戏进度'),
                                React.createElement('li', null, '• 清除浏览器数据会丢失本地存档'),
                                React.createElement('li', null, '• 建议定期导出重要存档进行备份')
                            )
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h3', { className: 'text-lg font-semibold' }, '系统设置'),
                        
                        React.createElement('div', { className: 'bg-red-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-red-800 mb-2' }, '数据管理'),
                            React.createElement('p', { className: 'text-xs text-red-700 mb-3' },
                                '重置将清除所有角色信息、旅行记录和日记。此操作不可撤销。'
                            ),
                            React.createElement('button', {
                                onClick: handleResetAllData,
                                className: 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500'
                            }, '重置所有数据')
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg' },
                        React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, '关于 Avatar Journey'),
                        React.createElement('div', { className: 'text-sm text-gray-600 space-y-2' },
                            React.createElement('p', null, '版本: 1.0.0 (MVP)'),
                            React.createElement('p', null, 'Avatar Journey 是一个基于 AI 的虚拟旅行游戏，让你的数字化身代替你去探索世界。'),
                            React.createElement('p', null, '通过智能对话系统，体验真实而有趣的旅行故事。'),
                            React.createElement('p', { className: 'text-green-600 font-medium' }, '✅ 数据现在会自动保存到浏览器本地，支持导入导出备份！')
                        )
                    )
                );
            };

            return React.createElement('div', { className: 'min-h-screen bg-gray-100' },
                React.createElement(Navigation, { currentPage: currentPage, setCurrentPage: setCurrentPage }),
                
                React.createElement('main', { className: 'py-6' },
                    currentPage === 'setup' && React.createElement(CharacterSetup),
                    currentPage === 'traveling' && React.createElement(TravelingView),
                    currentPage === 'diary' && React.createElement(DiaryView),
                    currentPage === 'settings' && React.createElement(SettingsView)
                )
            );
        };

        // =============== RENDER APP ===============
        ReactDOM.render(React.createElement(AvatarJourney), document.getElementById('root'));
    </script>
</body>
</html>
                                    )
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, '旅行风格'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                TRAVEL_STYLES.map(style => 
                                    React.createElement('label', { 
                                        key: style.id, 
                                        className: 'flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50' 
                                    },
                                        React.createElement('input', {
                                            type: 'radio',
                                            name: 'travelStyle',
                                            value: style.id,
                                            checked: state.character.travelStyle === style.id,
                                            onChange: (e) => handleCharacterChange('travelStyle', e.target.value),
                                            className: 'w-4 h-4 text-blue-600'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-medium text-sm' }, style.name),
                                            React.createElement('div', { className: 'text-xs text-gray-500' }, style.desc)
                                        )
                                    )

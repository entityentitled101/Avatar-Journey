<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar Journey - è™šæ‹Ÿæ—…è¡Œæ¸¸æˆ</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide-react/0.263.1/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { User, MapPin, BookOpen, Settings, Send } = lucide;

        // =============== CONSTANTS ===============
        const POPULAR_LOCATIONS = [
            'åŒ—äº¬', 'ä¸Šæµ·', 'æˆéƒ½', 'è¥¿å®‰', 'æ­å·', 'å—äº¬', 
            'ä¸œäº¬', 'é¦–å°”', 'æ›¼è°·', 'æ–°åŠ å¡', 'å·´é»', 'ä¼¦æ•¦',
            'çº½çº¦', 'æ´›æ‰çŸ¶', 'æ‚‰å°¼', 'ç½—é©¬'
        ];

        const TRAVEL_METHODS = [
            { id: 'driving', name: 'è‡ªé©¾æ¸¸', desc: 'å¼€è½¦è‡ªç”±è¡Œï¼Œçµæ´»å®‰æ’è·¯çº¿' },
            { id: 'walking', name: 'å¾’æ­¥æ—…è¡Œ', desc: 'æ­¥è¡Œæ¢ç´¢ï¼Œæ·±åº¦ä½“éªŒå½“åœ°' },
            { id: 'public', name: 'å…¬å…±äº¤é€š', desc: 'ç«è½¦ã€å·´å£«ç­‰å…¬å…±äº¤é€š' },
            { id: 'backpacking', name: 'èƒŒåŒ…å®¢', desc: 'ç»æµå®æƒ çš„èƒŒåŒ…æ—…è¡Œ' },
            { id: 'luxury', name: 'è±ªåæ—…è¡Œ', desc: 'èˆ’é€‚äº«å—çš„é«˜ç«¯æ—…è¡Œ' }
        ];

        const TRAVEL_STYLES = [
            { id: 'adventure', name: 'æ¢é™©å‹', desc: 'å¯»æ‰¾åˆºæ¿€å’Œæ–°å¥‡ä½“éªŒ' },
            { id: 'leisure', name: 'ä¼‘é—²å‹', desc: 'æ”¾æ¾èº«å¿ƒï¼Œæ…¢èŠ‚å¥æ¸¸è§ˆ' },
            { id: 'cultural', name: 'æ–‡åŒ–ä½“éªŒå‹', desc: 'æ·±å…¥äº†è§£å½“åœ°æ–‡åŒ–å†å²' },
            { id: 'foodie', name: 'ç¾é£Ÿå¯»è®¿å‹', desc: 'å“å°å„åœ°ç‰¹è‰²ç¾é£Ÿ' }
        ];

        const NAVIGATION_ITEMS = [
            { id: 'setup', name: 'è§’è‰²è®¾å®š', icon: User },
            { id: 'traveling', name: 'æ—…è¡Œä¸­', icon: MapPin },
            { id: 'diary', name: 'æ—…è¡Œæ—¥è®°', icon: BookOpen },
            { id: 'settings', name: 'è®¾ç½®', icon: Settings }
        ];

        // =============== API SERVICE ===============
        class APIService {
            constructor() {
                this.provider = 'CLAUDE';
                this.apiKey = '';
            }

            async callLLM(prompt, expectJSON = false) {
                try {
                    const response = await fetch("https://api.anthropic.com/v1/messages", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 1000,
                            messages: [{ role: "user", content: prompt }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();
                    let responseText = data.content[0].text;

                    if (expectJSON) {
                        responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
                        return JSON.parse(responseText);
                    }

                    return responseText;
                } catch (error) {
                    console.error("APIè°ƒç”¨é”™è¯¯:", error);
                    throw error;
                }
            }
        }

        const apiService = new APIService();

        // =============== STORAGE SERVICE ===============
        class StorageService {
            constructor() {
                this.STORAGE_KEY = 'avatar-journey-save';
                this.CURRENT_VERSION = '1.0.0';
            }

            save(data) {
                try {
                    const saveData = {
                        version: this.CURRENT_VERSION,
                        timestamp: Date.now(),
                        data: data
                    };
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(saveData));
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }

            load() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (!saved) return null;
                    
                    const saveData = JSON.parse(saved);
                    return this.migrateSaveData(saveData);
                } catch (error) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }

            exportSave(data) {
                try {
                    const saveData = {
                        version: this.CURRENT_VERSION,
                        exportTime: new Date().toISOString(),
                        gameTitle: 'Avatar Journey',
                        data: data
                    };
                    
                    const blob = new Blob([JSON.stringify(saveData, null, 2)], 
                        { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const filename = `avatar-journey-${data.character.name || 'save'}-${Date.now()}.json`;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    return true;
                } catch (error) {
                    console.error('å¯¼å‡ºå­˜æ¡£å¤±è´¥:', error);
                    return false;
                }
            }

            importSave(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const saveData = JSON.parse(e.target.result);
                            
                            if (!saveData.version || !saveData.data) {
                                throw new Error('å­˜æ¡£æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                            }
                            
                            const migratedData = this.migrateSaveData(saveData);
                            resolve(migratedData);
                        } catch (error) {
                            reject(new Error(`å¯¼å…¥å­˜æ¡£å¤±è´¥: ${error.message}`));
                        }
                    };
                    reader.onerror = () => {
                        reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
                    };
                    reader.readAsText(file);
                });
            }

            migrateSaveData(saveData) {
                try {
                    switch(saveData.version) {
                        case '1.0.0':
                            return saveData.data;
                        
                        case '0.9.0':
                            return this.upgradeTo1_0_0(saveData.data);
                        
                        default:
                            console.warn(`æœªçŸ¥çš„å­˜æ¡£ç‰ˆæœ¬: ${saveData.version}ï¼Œå°è¯•ç›´æ¥åŠ è½½`);
                            return saveData.data;
                    }
                } catch (error) {
                    throw new Error(`å­˜æ¡£ç‰ˆæœ¬ ${saveData.version} ä¸å…¼å®¹: ${error.message}`);
                }
            }

            upgradeTo1_0_0(oldData) {
                return {
                    ...oldData,
                    version: '1.0.0'
                };
            }

            clear() {
                try {
                    localStorage.removeItem(this.STORAGE_KEY);
                    return true;
                } catch (error) {
                    console.error('æ¸…é™¤å­˜æ¡£å¤±è´¥:', error);
                    return false;
                }
            }

            hasSave() {
                return localStorage.getItem(this.STORAGE_KEY) !== null;
            }

            getSaveInfo() {
                try {
                    const saved = localStorage.getItem(this.STORAGE_KEY);
                    if (!saved) return null;
                    
                    const saveData = JSON.parse(saved);
                    return {
                        version: saveData.version,
                        timestamp: saveData.timestamp,
                        saveTime: new Date(saveData.timestamp).toLocaleString(),
                        hasCharacter: !!(saveData.data && saveData.data.character && saveData.data.character.name),
                        characterName: saveData.data?.character?.name || '',
                        isActive: saveData.data?.travelState?.isActive || false
                    };
                } catch (error) {
                    console.error('è·å–å­˜æ¡£ä¿¡æ¯å¤±è´¥:', error);
                    return null;
                }
            }
        }

        const storageService = new StorageService();

        // =============== TRAVEL ENGINE ===============
        class TravelEngine {
            constructor() {
                this.scheduledTimeouts = new Map();
            }

            async startJourney(character, updateState) {
                if (!character.name || !character.departureLocation || !character.destination) {
                    throw new Error('è¯·å¡«å†™å®Œæ•´çš„è§’è‰²ä¿¡æ¯å’Œæ—…è¡Œé…ç½®');
                }

                const travelMethod = TRAVEL_METHODS.find(m => m.id === character.travelMethod);
                const travelStyle = TRAVEL_STYLES.find(s => s.id === character.travelStyle);
                
                const prompt = `
ä½ æ˜¯ä¸€ä¸ªè™šæ‹Ÿæ—…è¡Œæ¸¸æˆçš„AIåŠ©æ‰‹ï¼Œè´Ÿè´£ä¸ºç”¨æˆ·çš„è™šæ‹Ÿè§’è‰²ç”ŸæˆçœŸå®çš„æ—…è¡Œä½“éªŒã€‚

è§’è‰²è®¾å®šï¼š
- å§“åï¼š${character.name}
- æ€§æ ¼æè¿°ï¼š${character.description}
- å‡ºå‘åœ°ï¼š${character.departureLocation}
- ç›®çš„åœ°ï¼š${character.destination}
- æ—…è¡Œæ–¹å¼ï¼š${travelMethod?.name}
- æ—…è¡Œé£æ ¼ï¼š${travelStyle?.name}

ç°åœ¨æ˜¯${new Date().toLocaleString()}ï¼Œè§’è‰²åˆšå¼€å§‹è¿™æ¬¡æ—…è¡Œã€‚è¯·ç”Ÿæˆç¬¬ä¸€ä¸ªæ—…è¡Œäº‹ä»¶ï¼Œå¹¶ä¼°ç®—ä¸‹æ¬¡æ›´æ–°çš„æ—¶é—´ã€‚

è¯·ä»¥JSONæ ¼å¼å›å¤ï¼ŒåŒ…å«ä»¥ä¸‹å­—æ®µï¼š
{
  "currentLocation": "å½“å‰ä½ç½®ï¼ˆè¯¦ç»†åœ°ç‚¹ï¼‰",
  "currentActivity": "å½“å‰æ­£åœ¨åšçš„äº‹æƒ…",
  "eventDescription": "è¿™æ¬¡äº‹ä»¶çš„è¯¦ç»†æè¿°ï¼ˆ200å­—å·¦å³ï¼‰",
  "nextEventTime": "ä¸‹æ¬¡äº‹ä»¶é¢„è®¡å‘ç”Ÿçš„æ—¶é—´ï¼ˆå°æ—¶åï¼Œå¦‚1.5è¡¨ç¤º1.5å°æ—¶åï¼‰",
  "needsUserInput": false
}

è¦æ±‚ï¼š
1. ç”Ÿæˆåˆç†çœŸå®çš„æ—…è¡Œä½“éªŒ
2. è€ƒè™‘æ—…è¡Œæ–¹å¼å’Œä»å‡ºå‘åœ°åˆ°ç›®çš„åœ°çš„å®é™…æƒ…å†µ
3. äº‹ä»¶è¦æœ‰è¶£ä¸”ç¬¦åˆè§’è‰²è®¾å®š
4. æ—¶é—´ä¼°ç®—è¦åˆç†ï¼ˆé€šå¸¸0.5-3å°æ—¶ä¹‹é—´ï¼‰
`;

                const result = await apiService.callLLM(prompt, true);
                
                const newEvent = {
                    id: Date.now(),
                    timestamp: new Date(),
                    type: 'journey_start',
                    content: result.eventDescription,
                    needsUserInput: result.needsUserInput || false
                };

                updateState(prevState => ({
                    ...prevState,
                    events: [...prevState.events, newEvent],
                    travelState: {
                        isActive: true,
                        currentLocation: result.currentLocation,
                        currentActivity: result.currentActivity,
                        lastUpdate: new Date(),
                        nextEventTime: new Date(Date.now() + result.nextEventTime * 60 * 60 * 1000)
                    }
                }));
                
                this.scheduleNextEvent(result.nextEventTime, character, updateState);
                
                return result;
            }

            scheduleNextEvent(hoursLater, character, updateState) {
                const delay = hoursLater * 60 * 60 * 1000;
                const timeoutId = setTimeout(() => {
                    this.generateNextEvent(character, updateState);
                }, delay);
                
                this.scheduledTimeouts.set('nextEvent', timeoutId);
            }

            async generateNextEvent(character, updateState) {
                console.log('ç”Ÿæˆä¸‹ä¸€ä¸ªäº‹ä»¶...');
            }

            async handleUserIntervention(userMessage, character, currentState, updateState) {
                const prompt = `
${character.name}æ­£åœ¨æ—…è¡Œä¸­ã€‚

å½“å‰çŠ¶æ€ï¼š
- ä½ç½®ï¼š${currentState.travelState.currentLocation}
- æ´»åŠ¨ï¼š${currentState.travelState.currentActivity}

ç”¨æˆ·å‘æ¥æ¶ˆæ¯æƒ³è¦å¹²é¢„è§’è‰²çš„è¡ŒåŠ¨ï¼š"${userMessage}"

è¯·æ ¹æ®ç”¨æˆ·çš„å»ºè®®ï¼Œç”Ÿæˆè§’è‰²æ¥ä¸‹æ¥çš„è¡ŒåŠ¨å’Œé‡åˆ°çš„æƒ…å†µã€‚

è¯·ä»¥JSONæ ¼å¼å›å¤ï¼š
{
  "currentLocation": "ä½ç½®ï¼ˆå¯èƒ½æœ‰å˜åŒ–ï¼‰",
  "currentActivity": "æ ¹æ®ç”¨æˆ·å»ºè®®è°ƒæ•´çš„æ–°æ´»åŠ¨",
  "eventDescription": "æ ¹æ®ç”¨æˆ·å»ºè®®å‘ç”Ÿçš„æ–°æƒ…å†µï¼ˆ200å­—å·¦å³ï¼‰",
  "nextEventTime": "ä¸‹æ¬¡è‡ªåŠ¨äº‹ä»¶çš„æ—¶é—´ï¼ˆå°æ—¶åï¼‰",
  "needsUserInput": false
}
`;

                const result = await apiService.callLLM(prompt, true);
                
                const newEvent = {
                    id: Date.now(),
                    timestamp: new Date(),
                    type: 'user_intervention',
                    content: result.eventDescription,
                    needsUserInput: false,
                    userMessage: userMessage
                };

                updateState(prevState => ({
                    ...prevState,
                    events: [...prevState.events, newEvent],
                    travelState: {
                        ...prevState.travelState,
                        currentLocation: result.currentLocation,
                        currentActivity: result.currentActivity,
                        lastUpdate: new Date(),
                        nextEventTime: new Date(Date.now() + result.nextEventTime * 60 * 60 * 1000)
                    },
                    userMessage: ''
                }));

                this.scheduleNextEvent(result.nextEventTime, character, updateState);
                return result;
            }

            clearAllTimeouts() {
                for (const [key, timeoutId] of this.scheduledTimeouts) {
                    clearTimeout(timeoutId);
                }
                this.scheduledTimeouts.clear();
            }
        }

        const travelEngine = new TravelEngine();

        // =============== COMPONENTS ===============
        const Navigation = ({ currentPage, setCurrentPage }) => (
            React.createElement('nav', { className: 'bg-white shadow-sm' },
                React.createElement('div', { className: 'max-w-6xl mx-auto px-4' },
                    React.createElement('div', { className: 'flex space-x-8' },
                        NAVIGATION_ITEMS.map(item => {
                            const Icon = item.icon;
                            return React.createElement('button', {
                                key: item.id,
                                onClick: () => setCurrentPage(item.id),
                                className: `flex items-center space-x-2 py-4 px-2 border-b-2 font-medium text-sm ${
                                    currentPage === item.id
                                        ? 'border-blue-500 text-blue-600'
                                        : 'border-transparent text-gray-500 hover:text-gray-700'
                                }`
                            },
                                React.createElement(Icon, { className: 'w-4 h-4' }),
                                React.createElement('span', null, item.name)
                            );
                        })
                    )
                )
            )
        );

        const EventCard = ({ event }) => (
            React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
                React.createElement('div', { className: 'flex justify-between items-start mb-2' },
                    React.createElement('span', { className: 'text-sm text-gray-500' },
                        new Date(event.timestamp).toLocaleString()
                    ),
                    event.needsUserInput && React.createElement('span', { 
                        className: 'text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded' 
                    }, 'ç­‰å¾…é€‰æ‹©')
                ),
                event.userMessage && React.createElement('div', { className: 'text-sm text-blue-600 mb-2' },
                    `ğŸ’¬ ä½ çš„æŒ‡ç¤º: ${event.userMessage}`
                ),
                React.createElement('p', { className: 'text-gray-700' }, event.content)
            )
        );

        const MessageInput = ({ onSendMessage, isWaitingResponse, characterName }) => {
            const [message, setMessage] = useState('');

            const handleSend = () => {
                if (!message.trim() || isWaitingResponse) return;
                onSendMessage(message);
                setMessage('');
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            };

            return React.createElement('div', { className: 'space-y-3' },
                React.createElement('h3', { className: 'font-semibold' }, `ä¸ ${characterName} å¯¹è¯`),
                React.createElement('div', { className: 'flex gap-2' },
                    React.createElement('input', {
                        type: 'text',
                        value: message,
                        onChange: (e) => setMessage(e.target.value),
                        onKeyPress: handleKeyPress,
                        className: 'flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                        placeholder: 'ç»™è§’è‰²å‘é€å»ºè®®æˆ–æŒ‡ç¤º...',
                        disabled: isWaitingResponse
                    }),
                    React.createElement('button', {
                        onClick: handleSend,
                        disabled: isWaitingResponse || !message.trim(),
                        className: 'bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50'
                    },
                        React.createElement(Send, { className: 'w-4 h-4' })
                    )
                ),
                React.createElement('p', { className: 'text-xs text-gray-500' },
                    'ä½ å¯ä»¥å»ºè®®è§’è‰²çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼Œæ¯”å¦‚"å»å½“åœ°å¸‚åœºçœ‹çœ‹"æˆ–"å’Œé‚£ä¸ªäººç»§ç»­èŠå¤©"'
                )
            );
        };

        // =============== MAIN COMPONENT ===============
        const AvatarJourney = () => {
            const [currentPage, setCurrentPage] = useState('setup');
            const [state, setState] = useState({
                character: {
                    name: '',
                    description: '',
                    departureLocation: '',
                    destination: '',
                    travelMethod: '',
                    travelStyle: ''
                },
                travelState: {
                    isActive: false,
                    currentLocation: '',
                    currentActivity: '',
                    lastUpdate: null,
                    nextEventTime: null
                },
                events: [],
                diaries: [],
                userMessage: '',
                isWaitingResponse: false
            });

            const autoSave = (newState) => {
                setState(newState);
                setTimeout(() => {
                    storageService.save(newState);
                }, 1000);
            };

            useEffect(() => {
                const savedData = storageService.load();
                if (savedData) {
                    setState(savedData);
                    if (savedData.travelState.isActive) {
                        setCurrentPage('traveling');
                    }
                }
            }, []);

            const handleImportSave = async (file) => {
                try {
                    const importedData = await storageService.importSave(file);
                    setState(importedData);
                    storageService.save(importedData);
                    alert('å­˜æ¡£å¯¼å…¥æˆåŠŸï¼');
                    
                    if (importedData.travelState.isActive) {
                        setCurrentPage('traveling');
                    } else {
                        setCurrentPage('setup');
                    }
                } catch (error) {
                    alert(error.message);
                }
            };

            const handleExportSave = () => {
                const success = storageService.exportSave(state);
                if (success) {
                    alert('å­˜æ¡£å¯¼å‡ºæˆåŠŸï¼');
                } else {
                    alert('å­˜æ¡£å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            };

            // é¡µé¢ç»„ä»¶
            const CharacterSetup = () => {
                const handleCharacterChange = (field, value) => {
                    const newState = {
                        ...state,
                        character: { ...state.character, [field]: value }
                    };
                    autoSave(newState);
                };

                const handleStartJourney = async () => {
                    const newState = { ...state, isWaitingResponse: true };
                    setState(newState);
                    try {
                        await travelEngine.startJourney(state.character, autoSave);
                        setCurrentPage('traveling');
                    } catch (error) {
                        alert(error.message);
                    } finally {
                        const finalState = { ...state, isWaitingResponse: false };
                        autoSave(finalState);
                    }
                };

                const saveInfo = storageService.getSaveInfo();

                return React.createElement('div', { className: 'max-w-2xl mx-auto p-6 space-y-6' },
                    React.createElement('div', { className: 'text-center' },
                        React.createElement('h1', { className: 'text-3xl font-bold text-blue-600 mb-2' }, 'Avatar Journey'),
                        React.createElement('p', { className: 'text-gray-600' }, 'åˆ›å»ºä½ çš„è™šæ‹ŸåŒ–èº«ï¼Œå¼€å§‹ä¸€æ®µå¥‡å¦™çš„æ—…ç¨‹')
                    ),
                    
                    saveInfo && React.createElement('div', { className: 'bg-green-50 border border-green-200 rounded-lg p-4' },
                        React.createElement('h3', { className: 'text-sm font-medium text-green-800 mb-2' }, 'ğŸ“ å‘ç°å­˜æ¡£'),
                        React.createElement('div', { className: 'text-sm text-green-700 space-y-1' },
                            React.createElement('p', null, `è§’è‰²: ${saveInfo.characterName || 'æœªå‘½å'}`),
                            React.createElement('p', null, `ä¿å­˜æ—¶é—´: ${saveInfo.saveTime}`),
                            React.createElement('p', null, `çŠ¶æ€: ${saveInfo.isActive ? 'ğŸŒ æ—…è¡Œä¸­' : 'ğŸ“ è§’è‰²è®¾å®š'}`)
                        ),
                        saveInfo.isActive && React.createElement('button', {
                            onClick: () => setCurrentPage('traveling'),
                            className: 'mt-2 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700'
                        }, 'ç»§ç»­æ—…ç¨‹')
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
                            React.createElement(User, { className: 'w-5 h-5' }),
                            'è§’è‰²è®¾å®š'
                        ),
                        
                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'è§’è‰²å§“å'),
                            React.createElement('input', {
                                type: 'text',
                                value: state.character.name,
                                onChange: (e) => handleCharacterChange('name', e.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                placeholder: 'ç»™ä½ çš„è™šæ‹Ÿè§’è‰²èµ·ä¸ªåå­—'
                            })
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'è§’è‰²æè¿°'),
                            React.createElement('textarea', {
                                value: state.character.description,
                                onChange: (e) => handleCharacterChange('description', e.target.value),
                                className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                rows: 3,
                                placeholder: 'æè¿°è§’è‰²çš„æ€§æ ¼ã€å…´è¶£çˆ±å¥½ã€èƒŒæ™¯ç­‰'
                            })
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h2', { className: 'text-xl font-semibold flex items-center gap-2' },
                            React.createElement(MapPin, { className: 'w-5 h-5' }),
                            'æ—…è¡Œé…ç½®'
                        ),
                        
                        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'å‡ºå‘åœ°'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: state.character.departureLocation,
                                    onChange: (e) => handleCharacterChange('departureLocation', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                    placeholder: 'é€‰æ‹©å‡ºå‘åŸå¸‚',
                                    list: 'locations'
                                })
                            ),
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-1' }, 'ç›®çš„åœ°'),
                                React.createElement('input', {
                                    type: 'text',
                                    value: state.character.destination,
                                    onChange: (e) => handleCharacterChange('destination', e.target.value),
                                    className: 'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500',
                                    placeholder: 'é€‰æ‹©ç›®çš„åœ°åŸå¸‚',
                                    list: 'locations'
                                })
                            )
                        ),

                        React.createElement('datalist', { id: 'locations' },
                            POPULAR_LOCATIONS.map(location => 
                                React.createElement('option', { key: location, value: location })
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'æ—…è¡Œæ–¹å¼'),
                            React.createElement('div', { className: 'grid grid-cols-1 gap-2' },
                                TRAVEL_METHODS.map(method => 
                                    React.createElement('label', { 
                                        key: method.id, 
                                        className: 'flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50' 
                                    },
                                        React.createElement('input', {
                                            type: 'radio',
                                            name: 'travelMethod',
                                            value: method.id,
                                            checked: state.character.travelMethod === method.id,
                                            onChange: (e) => handleCharacterChange('travelMethod', e.target.value),
                                            className: 'w-4 h-4 text-blue-600'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-medium' }, method.name),
                                            React.createElement('div', { className: 'text-sm text-gray-500' }, method.desc)
                                        )
                            )
                        ),

                        React.createElement('button', {
                            onClick: handleStartJourney,
                            disabled: state.isWaitingResponse || !state.character.name || !state.character.departureLocation || !state.character.destination,
                            className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50'
                        }, state.isWaitingResponse ? 'æ­£åœ¨å‡†å¤‡æ—…ç¨‹...' : 'å¼€å§‹æ—…ç¨‹')
                    )
                );
            };

            const TravelingView = () => {
                const handleSendMessage = async (message) => {
                    if (!message.trim() || state.isWaitingResponse) return;
                    
                    const newState = { ...state, isWaitingResponse: true };
                    setState(newState);
                    try {
                        await travelEngine.handleUserIntervention(message, state.character, state, autoSave);
                    } catch (error) {
                        alert('å‘é€æ¶ˆæ¯æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
                        console.error(error);
                    } finally {
                        const finalState = { ...state, isWaitingResponse: false };
                        autoSave(finalState);
                    }
                };

                if (!state.travelState.isActive) {
                    return React.createElement('div', { className: 'max-w-4xl mx-auto p-6' },
                        React.createElement('div', { className: 'text-center text-gray-500 py-12' },
                            React.createElement(User, { className: 'w-12 h-12 mx-auto mb-4 text-gray-300' }),
                            React.createElement('p', null, 'è¿˜æ²¡æœ‰å¼€å§‹æ—…è¡Œ'),
                            React.createElement('p', { className: 'text-sm' }, 'è¯·å…ˆè®¾ç½®è§’è‰²ä¿¡æ¯å¹¶å¼€å§‹æ—…ç¨‹')
                        )
                    );
                }

                return React.createElement('div', { className: 'max-w-4xl mx-auto p-6 space-y-6' },
                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg' },
                        React.createElement('h2', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
                            React.createElement(User, { className: 'w-5 h-5' }),
                            `${state.character.name} çš„æ—…ç¨‹`
                        ),
                        
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-4' },
                            React.createElement('div', { className: 'bg-blue-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-blue-800' }, 'å½“å‰ä½ç½®'),
                                React.createElement('p', { className: 'text-blue-600' }, state.travelState.currentLocation)
                            ),
                            React.createElement('div', { className: 'bg-green-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-green-800' }, 'æ­£åœ¨è¿›è¡Œ'),
                                React.createElement('p', { className: 'text-green-600' }, state.travelState.currentActivity)
                            ),
                            React.createElement('div', { className: 'bg-orange-50 p-4 rounded-lg' },
                                React.createElement('h3', { className: 'font-medium text-orange-800' }, 'æœ€åæ›´æ–°'),
                                React.createElement('p', { className: 'text-orange-600' },
                                    state.travelState.lastUpdate ? new Date(state.travelState.lastUpdate).toLocaleString() : ''
                                )
                            )
                        ),

                        React.createElement('div', { className: 'space-y-4' },
                            React.createElement('h3', { className: 'font-semibold' }, 'æ—…è¡Œè®°å½•'),
                            React.createElement('div', { className: 'space-y-3 max-h-96 overflow-y-auto' },
                                state.events.length === 0 ? 
                                    React.createElement('div', { className: 'text-center text-gray-500 py-8' },
                                        React.createElement('p', null, 'æ—…è¡Œè®°å½•å°†åœ¨è¿™é‡Œæ˜¾ç¤º')
                                    ) :
                                    state.events.map(event => 
                                        React.createElement(EventCard, { key: event.id, event: event })
                                    )
                            )
                        ),

                        React.createElement('div', { className: 'mt-6' },
                            React.createElement(MessageInput, {
                                onSendMessage: handleSendMessage,
                                isWaitingResponse: state.isWaitingResponse,
                                characterName: state.character.name
                            })
                        )
                    )
                );
            };

            const DiaryView = () => (
                React.createElement('div', { className: 'max-w-3xl mx-auto p-6 space-y-6' },
                    React.createElement('h2', { className: 'text-2xl font-semibold flex items-center gap-2' },
                        React.createElement(BookOpen, { className: 'w-6 h-6' }),
                        state.character.name ? `${state.character.name} çš„æ—…è¡Œæ—¥è®°` : 'æ—…è¡Œæ—¥è®°'
                    ),
                    
                    state.diaries.length === 0 ? 
                        React.createElement('div', { className: 'text-center text-gray-500 py-12' },
                            React.createElement(BookOpen, { className: 'w-12 h-12 mx-auto mb-4 text-gray-300' }),
                            React.createElement('p', null, 'è¿˜æ²¡æœ‰æ—¥è®°è®°å½•'),
                            React.createElement('p', { className: 'text-sm' }, 'å¼€å§‹æ—…è¡Œåä¼šè‡ªåŠ¨ç”Ÿæˆæ¯æ—¥æ—¥è®°')
                        ) :
                        React.createElement('div', { className: 'space-y-6' },
                            state.diaries.map(diary => 
                                React.createElement('div', { key: diary.id, className: 'bg-white rounded-lg p-6 shadow-lg' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-2' }, diary.date),
                                    React.createElement('h4', { className: 'text-md font-medium text-blue-600 mb-3' }, diary.title),
                                    React.createElement('p', { className: 'text-gray-700 leading-relaxed mb-4' }, diary.content),
                                    diary.keyEvents && diary.keyEvents.length > 0 && 
                                        React.createElement('div', null,
                                            React.createElement('h5', { className: 'text-sm font-medium text-gray-600 mb-2' }, 'å…³é”®äº‹ä»¶ï¼š'),
                                            React.createElement('ul', { className: 'text-sm text-gray-500 space-y-1' },
                                                diary.keyEvents.map((event, index) => 
                                                    React.createElement('li', { key: index }, `â€¢ ${event}`)
                                                )
                                            )
                                        )
                                )
                            )
                        )
                )
            );

            const SettingsView = () => {
                const handleResetAllData = () => {
                    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ—…è¡Œè®°å½•å’Œè§’è‰²ä¿¡æ¯ã€‚')) {
                        travelEngine.clearAllTimeouts();
                        storageService.clear();
                        const newState = {
                            character: {
                                name: '',
                                description: '',
                                departureLocation: '',
                                destination: '',
                                travelMethod: '',
                                travelStyle: ''
                            },
                            travelState: {
                                isActive: false,
                                currentLocation: '',
                                currentActivity: '',
                                lastUpdate: null,
                                nextEventTime: null
                            },
                            events: [],
                            diaries: [],
                            userMessage: '',
                            isWaitingResponse: false
                        };
                        setState(newState);
                        setCurrentPage('setup');
                        alert('æ‰€æœ‰æ•°æ®å·²é‡ç½®');
                    }
                };

                const handleFileImport = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        handleImportSave(file);
                        event.target.value = '';
                    }
                };

                const saveInfo = storageService.getSaveInfo();

                return React.createElement('div', { className: 'max-w-2xl mx-auto p-6 space-y-6' },
                    React.createElement('h2', { className: 'text-2xl font-semibold flex items-center gap-2' },
                        React.createElement(Settings, { className: 'w-6 h-6' }),
                        'è®¾ç½®'
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h3', { className: 'text-lg font-semibold' }, 'å­˜æ¡£ç®¡ç†'),
                        
                        saveInfo && React.createElement('div', { className: 'bg-blue-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-blue-800 mb-2' }, 'ğŸ“ å½“å‰å­˜æ¡£'),
                            React.createElement('div', { className: 'text-sm text-blue-700 space-y-1' },
                                React.createElement('p', null, `è§’è‰²: ${saveInfo.characterName || 'æœªå‘½å'}`),
                                React.createElement('p', null, `ä¿å­˜æ—¶é—´: ${saveInfo.saveTime}`),
                                React.createElement('p', null, `çŠ¶æ€: ${saveInfo.isActive ? 'ğŸŒ æ—…è¡Œä¸­' : 'ğŸ“ è§’è‰²è®¾å®š'}`),
                                React.createElement('p', null, `ç‰ˆæœ¬: ${saveInfo.version}`)
                            )
                        ),

                        React.createElement('div', { className: 'space-y-3' },
                            React.createElement('div', null,
                                React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'å¯¼å…¥å­˜æ¡£'),
                                React.createElement('input', {
                                    type: 'file',
                                    accept: '.json',
                                    onChange: handleFileImport,
                                    className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100'
                                }),
                                React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'é€‰æ‹© .json æ ¼å¼çš„å­˜æ¡£æ–‡ä»¶')
                            ),

                            React.createElement('button', {
                                onClick: handleExportSave,
                                disabled: !saveInfo,
                                className: 'w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed'
                            }, 'å¯¼å‡ºå½“å‰å­˜æ¡£')
                        ),

                        React.createElement('div', { className: 'bg-yellow-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-yellow-800 mb-2' }, 'ğŸ’¡ å­˜æ¡£è¯´æ˜'),
                            React.createElement('ul', { className: 'text-xs text-yellow-700 space-y-1' },
                                React.createElement('li', null, 'â€¢ æ¸¸æˆæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨'),
                                React.createElement('li', null, 'â€¢ å¯¼å‡ºå­˜æ¡£å¯ä»¥å¤‡ä»½åˆ°æœ¬åœ°æ–‡ä»¶'),
                                React.createElement('li', null, 'â€¢ å¯¼å…¥å­˜æ¡£å¯ä»¥æ¢å¤ä¹‹å‰çš„æ¸¸æˆè¿›åº¦'),
                                React.createElement('li', null, 'â€¢ æ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šä¸¢å¤±æœ¬åœ°å­˜æ¡£'),
                                React.createElement('li', null, 'â€¢ å»ºè®®å®šæœŸå¯¼å‡ºé‡è¦å­˜æ¡£è¿›è¡Œå¤‡ä»½')
                            )
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg space-y-4' },
                        React.createElement('h3', { className: 'text-lg font-semibold' }, 'ç³»ç»Ÿè®¾ç½®'),
                        
                        React.createElement('div', { className: 'bg-red-50 p-4 rounded-lg' },
                            React.createElement('h4', { className: 'text-sm font-medium text-red-800 mb-2' }, 'æ•°æ®ç®¡ç†'),
                            React.createElement('p', { className: 'text-xs text-red-700 mb-3' },
                                'é‡ç½®å°†æ¸…é™¤æ‰€æœ‰è§’è‰²ä¿¡æ¯ã€æ—…è¡Œè®°å½•å’Œæ—¥è®°ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚'
                            ),
                            React.createElement('button', {
                                onClick: handleResetAllData,
                                className: 'bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500'
                            }, 'é‡ç½®æ‰€æœ‰æ•°æ®')
                        )
                    ),

                    React.createElement('div', { className: 'bg-white rounded-lg p-6 shadow-lg' },
                        React.createElement('h3', { className: 'text-lg font-semibold mb-4' }, 'å…³äº Avatar Journey'),
                        React.createElement('div', { className: 'text-sm text-gray-600 space-y-2' },
                            React.createElement('p', null, 'ç‰ˆæœ¬: 1.0.0 (MVP)'),
                            React.createElement('p', null, 'Avatar Journey æ˜¯ä¸€ä¸ªåŸºäº AI çš„è™šæ‹Ÿæ—…è¡Œæ¸¸æˆï¼Œè®©ä½ çš„æ•°å­—åŒ–èº«ä»£æ›¿ä½ å»æ¢ç´¢ä¸–ç•Œã€‚'),
                            React.createElement('p', null, 'é€šè¿‡æ™ºèƒ½å¯¹è¯ç³»ç»Ÿï¼Œä½“éªŒçœŸå®è€Œæœ‰è¶£çš„æ—…è¡Œæ•…äº‹ã€‚'),
                            React.createElement('p', { className: 'text-green-600 font-medium' }, 'âœ… æ•°æ®ç°åœ¨ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°ï¼Œæ”¯æŒå¯¼å…¥å¯¼å‡ºå¤‡ä»½ï¼')
                        )
                    )
                );
            };

            return React.createElement('div', { className: 'min-h-screen bg-gray-100' },
                React.createElement(Navigation, { currentPage: currentPage, setCurrentPage: setCurrentPage }),
                
                React.createElement('main', { className: 'py-6' },
                    currentPage === 'setup' && React.createElement(CharacterSetup),
                    currentPage === 'traveling' && React.createElement(TravelingView),
                    currentPage === 'diary' && React.createElement(DiaryView),
                    currentPage === 'settings' && React.createElement(SettingsView)
                )
            );
        };

        // =============== RENDER APP ===============
        ReactDOM.render(React.createElement(AvatarJourney), document.getElementById('root'));
    </script>
</body>
</html>
                                    )
                                )
                            )
                        ),

                        React.createElement('div', null,
                            React.createElement('label', { className: 'block text-sm font-medium text-gray-700 mb-2' }, 'æ—…è¡Œé£æ ¼'),
                            React.createElement('div', { className: 'grid grid-cols-2 gap-2' },
                                TRAVEL_STYLES.map(style => 
                                    React.createElement('label', { 
                                        key: style.id, 
                                        className: 'flex items-center space-x-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50' 
                                    },
                                        React.createElement('input', {
                                            type: 'radio',
                                            name: 'travelStyle',
                                            value: style.id,
                                            checked: state.character.travelStyle === style.id,
                                            onChange: (e) => handleCharacterChange('travelStyle', e.target.value),
                                            className: 'w-4 h-4 text-blue-600'
                                        }),
                                        React.createElement('div', null,
                                            React.createElement('div', { className: 'font-medium text-sm' }, style.name),
                                            React.createElement('div', { className: 'text-xs text-gray-500' }, style.desc)
                                        )
                                    )
